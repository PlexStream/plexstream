<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PlexStream</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif;}
body{background:#0a0a0a;color:#fff;line-height:1.5;}
button{cursor:pointer;border:none;border-radius:4px;padding:8px 16px;background:linear-gradient(90deg,#a259ff,#1e90ff);color:#fff;transition: filter 0.2s;}
button:hover{filter: brightness(0.85);}
header,footer{display:flex;justify-content:space-between;align-items:center;padding:15px 30px;background:#111;}
main{padding:20px; max-width:1200px; margin:auto;}
#chat-container,#messages{height:250px;overflow-y:auto;background:#111;padding:10px;border-radius:6px;margin-top:10px;}
.flex-row{display:flex;align-items:center;gap:10px;}
.hidden{display:none;}
video{width:100%;max-width:500px;margin:10px 0;border-radius:8px;background:#000;}
#search-results{margin-top:15px;}
.result-card{background:#222;padding:10px;margin:5px 0;border-radius:6px;cursor:pointer;}
</style>
</head>
<body>

<header>
<div id="logo"><strong>PlexStream</strong></div>
<input type="text" id="searchInput" placeholder="Search streams...">
<button onclick="searchStreams()">Search</button>
<div id="user-actions"><button onclick="showLogin()">Login / Signup</button></div>
</header>

<main>
<!-- HOME -->
<section id="home">
<h1>Welcome to PlexStream</h1>
<div class="flex-row">
<button id="go-live-btn">Go Live</button>
</div>
<h2>Featured Streams</h2>
<div class="carousel" id="featured-streams"></div>
<h2>Live Channels You Follow</h2>
<div class="grid" id="followed-streams"></div>
<div id="search-results"></div>
</section>

<!-- VIEWER -->
<section id="viewer" class="hidden">
<h2 id="viewer-title">Stream Title</h2>
<video id="viewerVideo" autoplay controls></video>
<div id="chat-container"></div>
<div class="flex-row">
<input id="chatInput" placeholder="Type a message...">
<button id="chatSendBtn">Send</button>
</div>
</section>

<!-- DASHBOARD -->
<section id="dashboard" class="hidden">
<h2>Streamer Dashboard</h2>
<video id="broadcasterVideo" autoplay playsinline></video>
<label>Stream Title:<input type="text" id="streamTitle"/></label>
<label>Category:
<select id="streamCategory">
<option value="gaming">Gaming</option>
<option value="music">Music</option>
<option value="chat">Chat</option>
</select>
</label>
<div class="flex-row">
<button id="start-stream-btn">Start Streaming</button>
<button id="stop-stream-btn" class="hidden">Stop Streaming</button>
</div>
<p>Stream Key: <span id="stream-key">XXXX-XXXX</span> <button onclick="copyKey()">Copy</button></p>
<div id="messages"></div>
<input id="chatInputDashboard" placeholder="Type a message...">
<button onclick="sendMessageDashboard()">Send</button>
</section>

<!-- LOGIN MODAL -->
<section id="login-modal" class="hidden">
<h2>Login / Signup</h2>
<label>Username:<input type="text" id="login-user"/></label>
<label>Password:<input type="password" id="login-pass"/></label>
<div class="flex-row">
<button onclick="login()">Login</button>
<button onclick="signup()">Signup</button>
<button onclick="hideLogin()">Close</button>
</div>
</section>
</main>

<footer>
<div>PlexStream &copy; 2025</div>
</footer>

<script>
let currentUser = null;
let peerConnection;
const config={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};
let ws = new WebSocket("ws://localhost:8080");

// NAV
function showSection(id){document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));document.getElementById(id).classList.remove('hidden');}

// LOGIN
function showLogin(){document.getElementById('login-modal').classList.remove('hidden');}
function hideLogin(){document.getElementById('login-modal').classList.add('hidden');}
function login(){const u=document.getElementById('login-user').value.trim();const p=document.getElementById('login-pass').value.trim();if(u && p){currentUser=u;alert('Logged in as '+u);hideLogin();document.getElementById('user-actions').innerHTML=`<span>${u}</span> <button onclick="logout()">Logout</button>`;}}
function signup(){login();}
function logout(){currentUser=null;document.getElementById('user-actions').innerHTML=`<button onclick="showLogin()">Login / Signup</button>`;alert('Logged out');}

// SEARCH
function searchStreams(){
    const q=document.getElementById('searchInput').value;
    ws.send(JSON.stringify({type:"search",query:q}));
}

// CHAT
const chatDiv=document.getElementById("chat-container");
const chatInput=document.getElementById("chatInput");
const chatInputDash=document.getElementById("chatInputDashboard");
const messagesDiv=document.getElementById("messages");

function renderChat(user,msg){
    const p=document.createElement("p");
    p.textContent = user+": "+msg;
    chatDiv.appendChild(p.cloneNode(true));
    messagesDiv.appendChild(p.cloneNode(true));
    chatDiv.scrollTop=chatDiv.scrollHeight;
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

function sendMessage(){if(!currentUser)return alert("Login first");const m=chatInput.value.trim();if(m){ws.send(JSON.stringify({type:"chat",user:currentUser,chat:m}));chatInput.value='';}}
function sendMessageDashboard(){if(!currentUser)return alert("Login first");const m=chatInputDash.value.trim();if(m){ws.send(JSON.stringify({type:"chat",user:currentUser,chat:m}));chatInputDash.value='';}}

// DASHBOARD / BROADCAST
const startBtn=document.getElementById("start-stream-btn");
const stopBtn=document.getElementById("stop-stream-btn");
const broadcasterVideo=document.getElementById("broadcasterVideo");

startBtn.addEventListener("click",async ()=>{
    if(!currentUser)return alert("Login first");
    startBtn.classList.add("hidden");stopBtn.classList.remove("hidden");
    const stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    broadcasterVideo.srcObject=stream;
    peerConnection=new RTCPeerConnection(config);
    stream.getTracks().forEach(t=>peerConnection.addTrack(t,stream));
    peerConnection.onicecandidate=({candidate})=>{if(candidate) ws.send(JSON.stringify({type:"iceCandidate",iceCandidate:candidate}));};
    const offer=await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    const title=document.getElementById("streamTitle").value||"Untitled";
    const category=document.getElementById("streamCategory").value;
    ws.send(JSON.stringify({type:"offer",offer}));
    ws.send(JSON.stringify({type:"newStream",title,category,user:currentUser}));
});

stopBtn.addEventListener("click",()=>{
    stopBtn.classList.add("hidden");startBtn.classList.remove("hidden");
    if(peerConnection){peerConnection.getSenders().forEach(s=>peerConnection.removeTrack(s));peerConnection.close();peerConnection=null;}
    if(broadcasterVideo.srcObject){broadcasterVideo.srcObject.getTracks().forEach(t=>t.stop());broadcasterVideo.srcObject=null;}
    ws.send(JSON.stringify({type:"stopStream"}));
});

// COPY KEY
function copyKey(){navigator.clipboard.writeText(document.getElementById('stream-key').innerText);alert('Copied!');}

// JOIN STREAM
function joinStream(id){
    ws.send(JSON.stringify({type:"watchStream",id}));
    showSection("viewer");
}

// WEBSOCKET HANDLER
ws.onmessage=async ({data})=>{
    const msg=JSON.parse(data);
    if(msg.type==="chat"){renderChat(msg.user,msg.chat);}
    else if(msg.type==="searchResults"){renderResults(msg.results);}
    else if(msg.offer){
        peerConnection=new RTCPeerConnection(config);
        peerConnection.ontrack=(e)=>document.getElementById("viewerVideo").srcObject=e.streams[0];
        peerConnection.onicecandidate=({candidate})=>{if(candidate) ws.send(JSON.stringify({type:"iceCandidate",iceCandidate:candidate}));};
        await peerConnection.setRemoteDescription(new RTCSessionDescription(msg.offer));
        const answer=await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        ws.send(JSON.stringify({type:"answer",answer}));
    }else if(msg.answer){await peerConnection.setRemoteDescription(new RTCSessionDescription(msg.answer));}
    else if(msg.iceCandidate){await peerConnection.addIceCandidate(new RTCIceCandidate(msg.iceCandidate));}
};

// SEARCH RESULTS
function renderResults(list){
    const resultsDiv=document.getElementById("search-results");
    resultsDiv.innerHTML="";
    list.forEach(s=>{
        const div=document.createElement("div");
        div.className="result-card";
        div.textContent=s.title + " (LIVE)";
        div.onclick=()=>joinStream(s.id);
        resultsDiv.appendChild(div);
    });
}
</script>
</body>
</html>
